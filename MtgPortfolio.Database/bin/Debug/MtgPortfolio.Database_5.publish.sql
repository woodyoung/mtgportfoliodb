/*
Deployment script for MtgPortfolio

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "MtgPortfolio"
:setvar DefaultFilePrefix "MtgPortfolio"
:setvar DefaultDataPath "C:\Users\wyoung\AppData\Local\Microsoft\VisualStudio\SSDT"
:setvar DefaultLogPath "C:\Users\wyoung\AppData\Local\Microsoft\VisualStudio\SSDT"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
PRINT N'Dropping [Codes].[DF_Format_CreatedBy]...';


GO
ALTER TABLE [Codes].[Format] DROP CONSTRAINT [DF_Format_CreatedBy];


GO
PRINT N'Dropping [Codes].[DF_Format_CreatedOn]...';


GO
ALTER TABLE [Codes].[Format] DROP CONSTRAINT [DF_Format_CreatedOn];


GO
PRINT N'Dropping [Codes].[DF_Format_UpdatedBy]...';


GO
ALTER TABLE [Codes].[Format] DROP CONSTRAINT [DF_Format_UpdatedBy];


GO
PRINT N'Dropping [dbo].[FK_MtgCardLegalities_Format]...';


GO
ALTER TABLE [dbo].[MtgCardLegalities] DROP CONSTRAINT [FK_MtgCardLegalities_Format];


GO
PRINT N'Altering [dbo].[MtgCard]...';


GO
ALTER TABLE [dbo].[MtgCard]
    ADD [CreatedBy] VARCHAR (50) CONSTRAINT [DF_MtgCard_CreatedBy] DEFAULT (suser_name()) NOT NULL,
        [CreatedOn] DATETIME     CONSTRAINT [DF_MtgCard_CreatedOn] DEFAULT (getdate()) NOT NULL,
        [UpdatedBy] VARCHAR (50) CONSTRAINT [DF_MtgCard_UpdatedBy] DEFAULT (suser_name()) NOT NULL,
        [UpdatedOn] DATETIME     CONSTRAINT [DF_MtgCard_UpdatedOn] DEFAULT (getdate()) NOT NULL;


GO
PRINT N'Altering [dbo].[MtgCardColors]...';


GO
ALTER TABLE [dbo].[MtgCardColors]
    ADD [CreatedBy] VARCHAR (50) CONSTRAINT [DF_MtgCardColors_CreatedBy] DEFAULT (suser_name()) NOT NULL,
        [CreatedOn] DATETIME     CONSTRAINT [DF_MtgCardColors_CreatedOn] DEFAULT (getdate()) NOT NULL,
        [UpdatedBy] VARCHAR (50) CONSTRAINT [DF_MtgCardColors_UpdatedBy] DEFAULT (suser_name()) NOT NULL,
        [UpdatedOn] DATETIME     CONSTRAINT [DF_MtgCardColors_UpdatedOn] DEFAULT (getdate()) NOT NULL;


GO
PRINT N'Altering [dbo].[MtgCardLegalities]...';


GO
ALTER TABLE [dbo].[MtgCardLegalities]
    ADD [CreatedBy] VARCHAR (50) CONSTRAINT [DF_MtgCardLegalities_CreatedBy] DEFAULT (suser_name()) NOT NULL,
        [CreatedOn] DATETIME     CONSTRAINT [DF_MtgCardLegalities_CreatedOn] DEFAULT (getdate()) NOT NULL,
        [UpdatedBy] VARCHAR (50) CONSTRAINT [DF_MtgCardLegalities_UpdatedBy] DEFAULT (suser_name()) NOT NULL,
        [UpdatedOn] DATETIME     CONSTRAINT [DF_MtgCardLegalities_UpdatedOn] DEFAULT (getdate()) NOT NULL;


GO
PRINT N'Altering [dbo].[MtgCardSets]...';


GO
ALTER TABLE [dbo].[MtgCardSets]
    ADD [CreatedBy] VARCHAR (50) CONSTRAINT [DF_MtgCardSets_CreatedBy] DEFAULT (suser_name()) NOT NULL,
        [CreatedOn] DATETIME     CONSTRAINT [DF_MtgCardSets_CreatedOn] DEFAULT (getdate()) NOT NULL,
        [UpdatedBy] VARCHAR (50) CONSTRAINT [DF_MtgCardSets_UpdatedBy] DEFAULT (suser_name()) NOT NULL,
        [UpdatedOn] DATETIME     CONSTRAINT [DF_MtgCardSets_UpdatedOn] DEFAULT (getdate()) NOT NULL;


GO
PRINT N'Altering [dbo].[MtgCardSubtypes]...';


GO
ALTER TABLE [dbo].[MtgCardSubtypes]
    ADD [CreatedBy] VARCHAR (50) CONSTRAINT [DF_MtgCardSubtypes_CreatedBy] DEFAULT (suser_name()) NOT NULL,
        [CreatedOn] DATETIME     CONSTRAINT [DF_MtgCardSubtypes_CreatedOn] DEFAULT (getdate()) NOT NULL,
        [UpdatedBy] VARCHAR (50) CONSTRAINT [DF_MtgCardSubtypes_UpdatedBy] DEFAULT (suser_name()) NOT NULL,
        [UpdatedOn] DATETIME     CONSTRAINT [DF_MtgCardSubtypes_UpdatedOn] DEFAULT (getdate()) NOT NULL;


GO
PRINT N'Altering [dbo].[MtgCardSupertypes]...';


GO
ALTER TABLE [dbo].[MtgCardSupertypes]
    ADD [CreatedBy] VARCHAR (50) CONSTRAINT [DF_MtgCardSupertypes_CreatedBy] DEFAULT (suser_name()) NOT NULL,
        [CreatedOn] DATETIME     CONSTRAINT [DF_MtgCardSupertypes_CreatedOn] DEFAULT (getdate()) NOT NULL,
        [UpdatedBy] VARCHAR (50) CONSTRAINT [DF_MtgCardSupertypes_UpdatedBy] DEFAULT (suser_name()) NOT NULL,
        [UpdatedOn] DATETIME     CONSTRAINT [DF_MtgCardSupertypes_UpdatedOn] DEFAULT (getdate()) NOT NULL;


GO
PRINT N'Altering [dbo].[MtgCardTypes]...';


GO
ALTER TABLE [dbo].[MtgCardTypes]
    ADD [CreatedBy] VARCHAR (50) CONSTRAINT [DF_MtgCardTypes_CreatedBy] DEFAULT (suser_name()) NOT NULL,
        [CreatedOn] DATETIME     CONSTRAINT [DF_MtgCardTypes_CreatedOn] DEFAULT (getdate()) NOT NULL,
        [UpdatedBy] VARCHAR (50) CONSTRAINT [DF_MtgCardTypes_UpdatedBy] DEFAULT (suser_name()) NOT NULL,
        [UpdatedOn] DATETIME     CONSTRAINT [DF_MtgCardTypes_UpdatedOn] DEFAULT (getdate()) NOT NULL;


GO
PRINT N'Starting rebuilding table [Codes].[Format]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [Codes].[tmp_ms_xx_Format] (
    [FormatId]    INT          IDENTITY (1, 1) NOT NULL,
    [Code]        VARCHAR (20) NOT NULL,
    [Name]        VARCHAR (50) NOT NULL,
    [Description] VARCHAR (50) NOT NULL,
    [CreatedBy]   VARCHAR (50) CONSTRAINT [DF_Format_CreatedBy] DEFAULT (suser_name()) NOT NULL,
    [CreatedOn]   DATETIME     CONSTRAINT [DF_Format_CreatedOn] DEFAULT (getdate()) NOT NULL,
    [UpdatedBy]   VARCHAR (50) CONSTRAINT [DF_Format_UpdatedBy] DEFAULT (suser_name()) NOT NULL,
    [UpdatedOn]   DATETIME     NULL,
    CONSTRAINT [tmp_ms_xx_constraint_DF_Format_Up,
	CONSTRAINT [UQ_Format_Code1] UNIQUE NONCLUSTERED ([Code] ASC),
    CONSTRAINT [tmp_ms_xx_constraint_PK_FormatId1] PRIMARY KEY CLUSTERED ([FormatId] ASC) ON [PRIMARY]
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [Codes].[Format])
    BEGIN
        SET IDENTITY_INSERT [Codes].[tmp_ms_xx_Format] ON;
        INSERT INTO [Codes].[tmp_ms_xx_Format] ([FormatId], [Code], [Name], [Description], [CreatedBy], [CreatedOn], [UpdatedBy], [UpdatedOn])
        SELECT   [FormatId],
                 [Code],
                 [Name],
                 [Description],
                 [CreatedBy],
                 [CreatedOn],
                 [UpdatedBy],
                 [UpdatedOn]
        FROM     [Codes].[Format]
        ORDER BY [FormatId] ASC;
        SET IDENTITY_INSERT [Codes].[tmp_ms_xx_Format] OFF;
    END

DROP TABLE [Codes].[Format];

EXECUTE sp_rename N'[Codes].[tmp_ms_xx_Format]', N'Format';

EXECUTE sp_rename N'[Codes].[tmp_ms_xx_constraint_DF_Format_Up,
	CONSTRAINT [UQ_Format_Code1]', N'DF_Format_Up,
	CONSTRAINT [UQ_Format_Code', N'OBJECT';

EXECUTE sp_rename N'[Codes].[tmp_ms_xx_constraint_PK_FormatId1]', N'PK_FormatId', N'OBJECT';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Creating [Codes].[UQ_Border_Code]...';


GO
ALTER TABLE [Codes].[Border]
    ADD CONSTRAINT [UQ_Border_Code] UNIQUE NONCLUSTERED ([Code] ASC);


GO
PRINT N'Creating [Codes].[UQ_Color_Code]...';


GO
ALTER TABLE [Codes].[Color]
    ADD CONSTRAINT [UQ_Color_Code] UNIQUE NONCLUSTERED ([Code] ASC);


GO
PRINT N'Creating [Codes].[UQ_Layout_Code]...';


GO
ALTER TABLE [Codes].[Layout]
    ADD CONSTRAINT [UQ_Layout_Code] UNIQUE NONCLUSTERED ([Code] ASC);


GO
PRINT N'Creating [Codes].[UQ_Legality_Code]...';


GO
ALTER TABLE [Codes].[Legality]
    ADD CONSTRAINT [UQ_Legality_Code] UNIQUE NONCLUSTERED ([Code] ASC);


GO
PRINT N'Creating [Codes].[UQ_Rarity_Code]...';


GO
ALTER TABLE [Codes].[Rarity]
    ADD CONSTRAINT [UQ_Rarity_Code] UNIQUE NONCLUSTERED ([Code] ASC);


GO
PRINT N'Creating [Codes].[UQ_Set_Code]...';


GO
ALTER TABLE [Codes].[Set]
    ADD CONSTRAINT [UQ_Set_Code] UNIQUE NONCLUSTERED ([Code] ASC);


GO
PRINT N'Creating [Codes].[UQ_Subtype_Code]...';


GO
ALTER TABLE [Codes].[Subtype]
    ADD CONSTRAINT [UQ_Subtype_Code] UNIQUE NONCLUSTERED ([Code] ASC);


GO
PRINT N'Creating [Codes].[UQ_Supertype_Code]...';


GO
ALTER TABLE [Codes].[Supertype]
    ADD CONSTRAINT [UQ_Supertype_Code] UNIQUE NONCLUSTERED ([Code] ASC);


GO
PRINT N'Creating [Codes].[UQ_Type_Code]...';


GO
ALTER TABLE [Codes].[Type]
    ADD CONSTRAINT [UQ_Type_Code] UNIQUE NONCLUSTERED ([Code] ASC);


GO
PRINT N'Creating [dbo].[FK_MtgCardLegalities_Format]...';


GO
ALTER TABLE [dbo].[MtgCardLegalities] WITH NOCHECK
    ADD CONSTRAINT [FK_MtgCardLegalities_Format] FOREIGN KEY ([FormatId]) REFERENCES [Codes].[Format] ([FormatId]);


GO
PRINT N'Checking existing data against newly created constraints';


GO
USE [$(DatabaseName)];


GO
ALTER TABLE [dbo].[MtgCardLegalities] WITH CHECK CHECK CONSTRAINT [FK_MtgCardLegalities_Format];


GO
PRINT N'Update complete.';


GO
